name: Database Maintenance - Spark Plan

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# FIREBASE DATABASE MAINTENANCE (Spark Plan Compatible)
#
# This workflow maintains your Firebase Realtime Database to stay under 1GB
# - Runs daily at 2 AM Manila time (6 PM UTC)
# - Deletes raw data older than 60 days
# - Deletes hourly data older than 3 years
# - Creates daily aggregates
# - Reports database statistics
#
# FREE TIER USAGE: ~2 minutes/day = 60 minutes/month (well within 2,000 limit)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: "Force maintenance run (ignore time check)"
        required: false
        default: "false"

  schedule:
    # Daily at 6 PM UTC = 2 AM Manila (UTC+8)
    - cron: "0 18 * * *"

env:
  NODE_VERSION: "18"
  SCRIPTS_PATH: "./scripts"

jobs:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # DAILY DATABASE CLEANUP
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  daily-cleanup:
    name: ๐งน Daily Database Cleanup
    runs-on: ubuntu-latest

    steps:
      - name: ๐ฅ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ๐ข Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ๐ฆ Install Firebase Admin SDK
        run: |
          echo "๐ฆ Installing firebase-admin..."
          npm install firebase-admin
          echo "โ Installation complete!"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ๐ Verify Script Files
        run: |
          echo "๐ Verifying maintenance script..."

          if [ ! -f "database-maintenance.js" ]; then
            echo "โ ERROR: database-maintenance.js not found!"
            echo "๐ Available files:"
            ls -la
            exit 1
          fi

          echo "โ Script found: database-maintenance.js"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ๐๏ธ Run Database Maintenance
        id: maintenance
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐๏ธ STARTING DATABASE MAINTENANCE"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Date: $(date -u '+%Y-%m-%d')"
          echo "โฐ Time: $(date -u '+%H:%M:%S UTC') ($(date '+%H:%M:%S %Z'))"
          echo "๐ Run: #${{ github.run_number }}"
          echo ""

          # Check if we should run based on time (unless forced)
          CURRENT_HOUR=$(date -u '+%H')
          FORCE_RUN="${{ github.event.inputs.force_run }}"

          if [ "$FORCE_RUN" == "true" ]; then
            echo "๐ FORCED RUN - Ignoring time check"
            echo ""
          elif [ "$CURRENT_HOUR" != "18" ]; then
            echo "โญ๏ธ  SKIPPING - Not maintenance time"
            echo "   Current: $CURRENT_HOUR:00 UTC"
            echo "   Scheduled: 18:00 UTC (2 AM Manila)"
            echo "   Next run: $(date -u -d 'tomorrow 18:00' '+%Y-%m-%d %H:%M UTC')"
            echo ""
            echo "๐ก To force run manually, use 'Run workflow' with force_run=true"
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ Time check completed (maintenance skipped)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            exit 0
          else
            echo "โ Maintenance time confirmed (18:00 UTC = 2 AM Manila)"
            echo ""
          fi

          # Run the maintenance script
          node database-maintenance.js 2>&1 | tee maintenance-output.log
          exit_code=${PIPESTATUS[0]}

          echo ""
          if [ $exit_code -ne 0 ]; then
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ MAINTENANCE FAILED (Exit code: $exit_code)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""
            echo "๐ Error log:"
            cat maintenance-output.log
            echo ""
            exit $exit_code
          else
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ MAINTENANCE COMPLETED SUCCESSFULLY"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          fi
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: false

      - name: ๐ Display Summary
        if: steps.maintenance.outcome == 'success'
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ          DATABASE MAINTENANCE SUMMARY                  โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "โ Tasks Completed:"
          echo "   โข Deleted raw data older than 60 days"
          echo "   โข Deleted hourly data older than 3 years"
          echo "   โข Created daily aggregate for yesterday"
          echo "   โข Generated database statistics report"
          echo ""
          echo "๐ Check the logs above for detailed statistics"
          echo ""
          echo "๐ Next Maintenance:"
          echo "   โข Scheduled: $(date -u -d 'tomorrow 18:00' '+%Y-%m-%d 18:00 UTC')"
          echo "   โข Manila Time: $(date -d 'tomorrow 02:00' '+%Y-%m-%d 02:00 PHT')"
          echo ""
          echo "๐ก Manual Run:"
          echo "   โข Go to: Actions โ Database Maintenance"
          echo "   โข Click: Run workflow"
          echo "   โข Enable: force_run (to skip time check)"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ Maintenance Failed - Alert
        if: steps.maintenance.outcome == 'failure'
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ          โ๏ธ  MAINTENANCE FAILURE ALERT                 โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "โ Database maintenance failed!"
          echo ""
          echo "โ๏ธ  WARNINGS:"
          echo "   โข Old data may NOT be cleaned up"
          echo "   โข Database could grow beyond 1GB free tier"
          echo "   โข Historical aggregates may be missing"
          echo ""
          echo "๐ง Troubleshooting Steps:"
          echo "   1. Check Firebase service account key is valid"
          echo "   2. Verify database URL is correct"
          echo "   3. Ensure database-maintenance.js exists in scripts/"
          echo "   4. Check GitHub Secrets are configured correctly"
          echo "   5. Review error logs above for specific issues"
          echo ""
          echo "๐ง Contact System Administrator if issue persists"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          exit 1

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # HOURLY DATA AGGREGATION
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  hourly-aggregation:
    name: โฑ๏ธ Hourly Data Aggregation
    runs-on: ubuntu-latest

    steps:
      - name: ๐ฅ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ๐ข Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ๐ฆ Install Firebase Admin SDK
        run: |
          echo "๐ฆ Installing firebase-admin..."
          npm install firebase-admin
          echo "โ Installation complete!"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ๐ Verify Script Files
        run: |
          echo "๐ Verifying aggregation script..."

          if [ ! -f "hourly-aggregation.js" ]; then
            echo "โ ERROR: hourly-aggregation.js not found!"
            echo "๐ Available files:"
            ls -la
            exit 1
          fi

          echo "โ Script found: hourly-aggregation.js"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ๐ Create Hourly Aggregate
        id: aggregate
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โฑ๏ธ STARTING HOURLY AGGREGATION"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Date: $(date -u '+%Y-%m-%d')"
          echo "โฐ Time: $(date -u '+%H:%M:%S UTC')"
          echo "๐ Run: #${{ github.run_number }}"
          echo ""

          # Check if we should run (on the hour or within 15 minutes)
          CURRENT_MINUTE=$(date -u '+%M')

          if [ "$CURRENT_MINUTE" -le 15 ]; then
            echo "โ Running hourly aggregation (within 15 min of hour)"
            echo ""
          else
            echo "โญ๏ธ  SKIPPING - Not within aggregation window"
            echo "   Current minute: $CURRENT_MINUTE"
            echo "   Aggregation runs: :00 to :15 of each hour"
            echo "   Next run: At the top of next hour"
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ Time check completed (aggregation skipped)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            exit 0
          fi

          # Run the aggregation script
          node hourly-aggregation.js 2>&1 | tee aggregation-output.log
          exit_code=${PIPESTATUS[0]}

          echo ""
          if [ $exit_code -ne 0 ]; then
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ AGGREGATION FAILED (Exit code: $exit_code)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo ""
            echo "๐ Error log:"
            cat aggregation-output.log
            echo ""
            exit $exit_code
          else
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ AGGREGATION COMPLETED SUCCESSFULLY"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          fi
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: true

      - name: โ Aggregation Success
        if: steps.aggregate.outcome == 'success'
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ         HOURLY AGGREGATION SUMMARY                     โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "โ Hourly data compressed successfully"
          echo "   โข Previous hour's raw data aggregated"
          echo "   โข Saved to sensor_logs_hourly collection"
          echo "   โข Enables faster historical queries"
          echo ""
          echo "๐ Next aggregation: Top of next hour"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ๏ธ Aggregation Skipped or Failed
        if: steps.aggregate.outcome != 'success'
        run: |
          echo ""
          echo "โน๏ธ  Hourly aggregation did not complete"
          echo "   This is usually normal (wrong time or no data)"
          echo "   Check logs above for details"
          echo ""

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # HEALTH CHECK
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  health-check:
    name: ๐ฅ Database Health Check
    runs-on: ubuntu-latest
    needs: [daily-cleanup, hourly-aggregation]
    if: always()

    steps:
      - name: ๐ Generate Health Report
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ        DATABASE MAINTENANCE - HEALTH REPORT            โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Report Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "๐ Workflow Run: #${{ github.run_number }}"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโ JOB STATUS โโโโโโโโโโโโโโโโโโโโโโโ"
          echo "  ๐งน Daily Cleanup:        ${{ needs.daily-cleanup.result }}"
          echo "  โฑ๏ธ Hourly Aggregation:   ${{ needs.hourly-aggregation.result }}"
          echo ""

          # Overall status
          if [ "${{ needs.daily-cleanup.result }}" == "success" ]; then
            echo "โ DATABASE MAINTENANCE HEALTHY"
            echo ""
            echo "System Status:"
            echo "  โข Daily cleanup: Running at 2 AM Manila"
            echo "  โข Hourly aggregation: Running every hour"
            echo "  โข Data retention: 60 days raw, 3 years hourly"
            echo "  โข Storage optimization: Active"
            echo "  โข Free tier: Under 1GB maintained"
            echo ""
            echo "๐ Database Health: EXCELLENT"
          elif [ "${{ needs.daily-cleanup.result }}" == "skipped" ]; then
            echo "โน๏ธ  MAINTENANCE SKIPPED (Wrong time)"
            echo ""
            echo "This is normal when:"
            echo "  โข Current time is not 18:00 UTC (2 AM Manila)"
            echo "  โข Workflow triggered outside schedule"
            echo ""
            echo "Next scheduled maintenance:"
            echo "  โข $(date -u -d 'tomorrow 18:00' '+%Y-%m-%d 18:00 UTC')"
            echo "  โข $(date -d 'tomorrow 02:00' '+%Y-%m-%d 02:00 PHT')"
          else
            echo "โ๏ธ  ATTENTION REQUIRED"
            echo ""
            echo "โ Daily cleanup failed or incomplete"
            echo "   โ Old data may accumulate"
            echo "   โ Database could exceed 1GB free tier"
            echo "   โ Manual intervention may be needed"
            echo ""
            echo "๐ง Action Items:"
            echo "  1. Review error logs above"
            echo "  2. Check Firebase service account permissions"
            echo "  3. Verify database URL is correct"
            echo "  4. Run manual cleanup if needed"
            echo "  5. Monitor database size in Firebase Console"
          fi
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐พ Save Maintenance Log (Optional)
        if: needs.daily-cleanup.result == 'success'
        run: |
          echo "โ Maintenance completed successfully"
          echo "๐ Logs are available in the Actions tab"
          echo "๐ก Consider adding email notifications for failures"
