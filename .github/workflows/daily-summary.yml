name: Weather Monitoring System - Complete Automation

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# IMPORTANT: This workflow runs TWO SEPARATE monitoring systems:
#
# 1. REAL-TIME ALERTS (Every 15 minutes)
#    - Checks sensor readings against danger thresholds
#    - Sends EMAIL notifications immediately when thresholds are exceeded
#    - Script: check-all-alerts.js
#    - Purpose: IMMEDIATE ACTION on critical conditions
#
# 2. HISTORICAL SUMMARIES (Every 6 hours)
#    - Analyzes 24-hour trends and patterns
#    - Displays insights in the dashboard
#    - Script: generate-summary.js
#    - Purpose: UNDERSTANDING weather trends over time
#
# These are DIFFERENT systems serving DIFFERENT purposes!
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch: # Manual trigger for testing
    inputs:
      skip_alerts:
        description: "Skip real-time alert checking"
        required: false
        default: "false"
      skip_insights:
        description: "Skip historical summary generation"
        required: false
        default: "false"

  schedule:
    # REAL-TIME ALERTS - every 15 minutes (critical monitoring)
    - cron: "*/15 * * * *"

    # HISTORICAL SUMMARIES - every 6 hours (trend analysis)
    # Runs at: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 */6 * * *"

env:
  NODE_VERSION: "18"
  SCRIPTS_PATH: "./scripts"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: REAL-TIME ALERT MONITORING (Every 15 minutes)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  monitor-alerts:
    name: ğŸš¨ Real-Time Alert Monitoring
    runs-on: ubuntu-latest

    # Only run if it's the 15-minute schedule OR manual trigger with alerts enabled
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '*/15 * * * *') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_alerts != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸš¨ Check Thresholds (Email Only If Exceeded)
        id: check-alerts
        run: node check-all-alerts.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        continue-on-error: true

      - name: âœ… Alert Monitoring Success
        if: steps.check-alerts.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Real-time alert monitoring completed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ‰ï¸  Emails sent ONLY if thresholds were exceeded"
          echo "ğŸ“Š Check Firestore: alerts_history collection"
          echo "ğŸ”„ Next check: In 15 minutes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Alert Monitoring Failed
        if: steps.check-alerts.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Real-time alert monitoring failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âš ï¸  CRITICAL: Alerts may not be sent!"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: HISTORICAL SUMMARY GENERATION (Every 6 hours)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-insights:
    name: ğŸ“Š Historical Summary Generation
    runs-on: ubuntu-latest

    # Only run if it's the 6-hour schedule OR manual trigger with insights enabled
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_insights != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ“ˆ Generate 24-Hour Weather Summary
        id: generate-insights
        run: node generate-summary.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: true

      - name: âœ… Summary Generation Success
        if: steps.generate-insights.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Historical weather summary generated!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“Š Analysis: Last 24 hours of sensor data"
          echo "ğŸ’¾ Saved to: insights/daily_prediction (Realtime DB)"
          echo "ğŸ–¥ï¸  Visible in: Dashboard 'Smart Insights' card"
          echo "ğŸ”„ Next update: In 6 hours"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Summary Generation Failed
        if: steps.generate-insights.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Historical summary generation failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â„¹ï¸  Note: This is for dashboard display only"
          echo "âœ… Real-time alerts still work independently"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: SYSTEM HEALTH CHECK (Runs after both jobs when on 6-hour schedule)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  system-health-check:
    name: ğŸ¥ System Health Check
    runs-on: ubuntu-latest
    needs: [monitor-alerts, generate-insights]
    if: always() && github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *'

    steps:
      - name: ğŸ“Š Generate Status Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¥ WEATHER MONITORING SYSTEM - HEALTH REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Workflow Run: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOB STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš¨ Real-Time Alerts: ${{ needs.monitor-alerts.result }}"
          echo "  ğŸ“Š Historical Summary: ${{ needs.generate-insights.result }}"
          echo ""

          if [ "${{ needs.monitor-alerts.result }}" == "success" ] && [ "${{ needs.generate-insights.result }}" == "success" ]; then
            echo "âœ… ALL SYSTEMS OPERATIONAL"
            echo ""
            echo "System Status:"
            echo "  â€¢ Alert monitoring: Active (every 15 min)"
            echo "  â€¢ Summary analysis: Active (every 6 hours)"
            echo "  â€¢ Email notifications: Configured"
            echo ""
            echo "Next scheduled runs:"
            echo "  â€¢ Real-time alerts: In 15 minutes"
            echo "  â€¢ Historical summary: In 6 hours"
          else
            echo "âš ï¸  ATTENTION REQUIRED"
            echo ""
            if [ "${{ needs.monitor-alerts.result }}" != "success" ]; then
              echo "âŒ CRITICAL: Real-time alert system failed!"
              echo "   â†’ Email notifications may not be sent"
              echo "   â†’ Immediate investigation required"
            fi
            if [ "${{ needs.generate-insights.result }}" != "success" ]; then
              echo "âš ï¸  Warning: Summary generation failed"
              echo "   â†’ Dashboard insights not updated"
              echo "   â†’ Alerts still working independently"
            fi
            echo ""
            echo "Troubleshooting checklist:"
            echo "  1. âœ“ Firebase service account key is valid"
            echo "  2. âœ“ Gmail credentials are correct"
            echo "  3. âœ“ Sensor is sending data regularly"
            echo "  4. âœ“ Network connectivity is stable"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âš ï¸ Report System Failure
        if: needs.monitor-alerts.result == 'failure' || needs.generate-insights.result == 'failure'
        run: |
          echo "ğŸš¨ SYSTEM ALERT: One or more monitoring jobs failed!"
          echo "Please investigate immediately to ensure proper monitoring."
          exit 1
