name: Weather Monitoring System - Complete Automation

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# IMPORTANT: This workflow runs TWO SEPARATE monitoring systems:
#
# 1. REAL-TIME ALERTS (Every 15 minutes)
#    - Checks sensor readings against danger thresholds
#    - Sends EMAIL, PUSH NOTIFICATIONS, and SMS (via Semaphore) when thresholds are exceeded
#    - Script: check-all-alerts.js
#    - Purpose: IMMEDIATE ACTION on critical conditions
#
# 2. HISTORICAL SUMMARIES (Every 6 hours)
#    - Analyzes 24-hour trends and patterns
#    - Displays insights in the dashboard
#    - Script: generate-summary.js
#    - Purpose: UNDERSTANDING weather trends over time
#
# SMS Provider: Semaphore (Philippine-based, perfect for PH numbers!)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

on:
  workflow_dispatch: # Manual trigger for testing
    inputs:
      skip_alerts:
        description: "Skip real-time alert checking"
        required: false
        default: "false"
      skip_insights:
        description: "Skip historical summary generation"
        required: false
        default: "false"

  schedule:
    # REAL-TIME ALERTS - every 15 minutes (critical monitoring)
    - cron: "*/15 * * * *"

    # HISTORICAL SUMMARIES - every 6 hours (trend analysis)
    # Runs at: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 */6 * * *"

env:
  NODE_VERSION: "18"
  SCRIPTS_PATH: "./scripts"

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: REAL-TIME ALERT MONITORING (Every 15 minutes)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  monitor-alerts:
    name: ğŸš¨ Real-Time Alert Monitoring
    runs-on: ubuntu-latest

    # Only run if it's the 15-minute schedule OR manual trigger with alerts enabled
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '*/15 * * * *') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_alerts != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: |
          echo "Installing dependencies..."
          npm install --production
          echo "Installation complete!"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ” Verify Setup
        run: |
          echo "Verifying installation..."
          if [ ! -f "check-all-alerts.js" ]; then
            echo "âŒ ERROR: check-all-alerts.js not found!"
            exit 1
          fi
          if [ ! -d "node_modules" ]; then
            echo "âŒ ERROR: node_modules not found!"
            exit 1
          fi
          echo "âœ… Setup verified"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸš¨ Check Thresholds (Email & SMS If Exceeded)
        id: check-alerts
        run: |
          echo "Starting alert check..."
          node check-all-alerts.js 2>&1 | tee alert-output.log
          exit_code=$(printf "%s" "${PIPESTATUS[0]}")
          if [ $exit_code -ne 0 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ Script failed with exit code: $exit_code"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cat alert-output.log
            exit $exit_code
          fi
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          SEMAPHORE_API_KEY: ${{ secrets.SEMAPHORE_API_KEY }}
        continue-on-error: true

      - name: ğŸ“± Send Push Notifications
        if: steps.check-alerts.outcome == 'success'
        run: |
          echo "ğŸ“± Preparing to send push notifications..."

          # Install Firebase Admin SDK
          npm install firebase-admin

          # Create notification script
          cat > send-notifications.js << 'EOF'
          const admin = require('firebase-admin');
          const fs = require('fs');

          // Initialize Firebase Admin
          const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_KEY);
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
            databaseURL: "https://weather-monitoring-syste-3c1ea-default-rtdb.asia-southeast1.firebasedatabase.app"
          });

          const db = admin.firestore();

          async function sendNotifications() {
            try {
              // Check if alerts file exists (created by check-all-alerts.js)
              const alertsHistoryRef = db.collection('alerts_history').orderBy('timestamp', 'desc').limit(1);
              const snapshot = await alertsHistoryRef.get();
              
              if (snapshot.empty) {
                console.log('   â„¹ï¸  No recent alerts found - no notifications to send');
                return;
              }
              
              const latestAlert = snapshot.docs[0].data();
              
              // Check if this alert was just created (within last 5 minutes)
              const alertTime = latestAlert.timestamp?.toDate();
              const now = new Date();
              const timeDiff = (now - alertTime) / 1000 / 60; // minutes
              
              if (timeDiff > 5) {
                console.log('   â„¹ï¸  No new alerts in the last 5 minutes');
                return;
              }
              
              if (!latestAlert.alerts || latestAlert.alerts.length === 0) {
                console.log('   â„¹ï¸  No threshold violations in latest check');
                return;
              }
              
              // Get FCM tokens from Firestore
              console.log('   ğŸ“± Fetching FCM tokens from Firestore...');
              const tokensSnapshot = await db.collection('fcm_tokens').get();
              
              if (tokensSnapshot.empty) {
                console.log('   âš ï¸  No FCM tokens found in Firestore');
                console.log('   ğŸ’¡ Users need to enable notifications in the app');
                return;
              }
              
              const tokens = tokensSnapshot.docs.map(doc => doc.data().token);
              console.log(`   ğŸ“± Found ${tokens.length} registered device(s).`);
              
              // Prepare notification message
              const alertMessages = latestAlert.alerts.map(alert => 
                `${alert.parameter}: ${alert.value}${alert.unit} (threshold: ${alert.threshold}${alert.unit})`
              ).join('\n');
              
              const message = {
                notification: {
                  title: 'ğŸš¨ Weather Alert',
                  body: alertMessages
                },
                data: {
                  alertCount: latestAlert.alerts.length.toString(),
                  timestamp: new Date().toISOString(),
                  link: '/alerts'
                },
                tokens: tokens
              };
              
              // Send to all devices
              console.log('   ğŸ“¤ Sending notifications...');
              const response = await admin.messaging().sendEachForMulticast(message);
              
              console.log(`   âœ… Successfully sent to ${response.successCount} device(s).`);
              
              if (response.failureCount > 0) {
                console.log(`   âš ï¸  Failed to send to ${response.failureCount} device(s).`);
                response.responses.forEach((resp, idx) => {
                  if (!resp.success) {
                    console.log(`      Device ${idx + 1}: ${resp.error?.message}`);
                  }
                });
              }
              
            } catch (error) {
              console.error('   âŒ Error sending notifications:', error.message);
              console.log('   â„¹ï¸  Continuing workflow despite notification error...');
            }
          }

          sendNotifications().then(() => {
            console.log('   âœ… Push notification process completed');
            process.exit(0);
          }).catch(err => {
            console.error('   âŒ Fatal error:', err);
            process.exit(1);
          });
          EOF

          # Run the notification script
          node send-notifications.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: true

      - name: âœ… Alert Monitoring Success
        if: steps.check-alerts.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Real-time alert monitoring completed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ‰ï¸  Emails sent ONLY if thresholds were exceeded"
          echo "ğŸ“± Push notifications sent ONLY if thresholds were exceeded"
          echo "ğŸ“± SMS sent ONLY if enabled (via Semaphore - PH provider)"
          echo "ğŸ“Š Check Firestore: alerts_history collection"
          echo "ğŸ”„ Next check: In 15 minutes"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Alert Monitoring Failed
        if: steps.check-alerts.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Real-time alert monitoring failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âš ï¸  CRITICAL: Alerts may not be sent!"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: HISTORICAL SUMMARY GENERATION (Every 6 hours)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-insights:
    name: ğŸ“Š Historical Summary Generation
    runs-on: ubuntu-latest

    # Only run if it's the 6-hour schedule OR manual trigger with insights enabled
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *') || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_insights != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: |
          echo "Installing dependencies..."
          npm install --production
          echo "Installation complete!"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ” Verify Setup
        run: |
          echo "Verifying installation..."
          if [ ! -f "generate-summary.js" ]; then
            echo "âŒ ERROR: generate-summary.js not found!"
            exit 1
          fi
          if [ ! -d "node_modules" ]; then
            echo "âŒ ERROR: node_modules not found!"
            exit 1
          fi
          echo "âœ… Setup verified"
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ“ˆ Generate 24-Hour Weather Summary
        id: generate-insights
        run: |
          echo "Starting summary generation..."
          node generate-summary.js 2>&1 | tee summary-output.log
          exit_code=$(printf "%s" "${PIPESTATUS[0]}")
          if [ $exit_code -ne 0 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ Script failed with exit code: $exit_code"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cat summary-output.log
            exit $exit_code
          fi
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: true

      - name: âœ… Summary Generation Success
        if: steps.generate-insights.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Historical weather summary generated!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“Š Analysis: Last 24 hours of sensor data"
          echo "ğŸ’¾ Saved to: insights/daily_prediction (Realtime DB)"
          echo "ğŸ–¥ï¸  Visible in: Dashboard 'Smart Insights' card"
          echo "ğŸ”„ Next update: In 6 hours"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Summary Generation Failed
        if: steps.generate-insights.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Historical summary generation failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â„¹ï¸  Note: This is for dashboard display only"
          echo "âœ… Real-time alerts still work independently"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: SYSTEM HEALTH CHECK (Runs after both jobs when on 6-hour schedule)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  system-health-check:
    name: ğŸ¥ System Health Check
    runs-on: ubuntu-latest
    needs: [monitor-alerts, generate-insights]
    if: always() && github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *'

    steps:
      - name: ğŸ“Š Generate Status Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ¥ WEATHER MONITORING SYSTEM - HEALTH REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Workflow Run: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JOB STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸš¨ Real-Time Alerts: ${{ needs.monitor-alerts.result }}"
          echo "  ğŸ“Š Historical Summary: ${{ needs.generate-insights.result }}"
          echo ""

          if [ "${{ needs.monitor-alerts.result }}" == "success" ] && [ "${{ needs.generate-insights.result }}" == "success" ]; then
            echo "âœ… ALL SYSTEMS OPERATIONAL"
            echo ""
            echo "System Status:"
            echo "  â€¢ Alert monitoring: Active (every 15 min)"
            echo "  â€¢ Summary analysis: Active (every 6 hours)"
            echo "  â€¢ Email notifications: Configured"
            echo "  â€¢ Push notifications: Configured"
            echo "  â€¢ SMS notifications: Semaphore (PH provider)"
            echo ""
            echo "Next scheduled runs:"
            echo "  â€¢ Real-time alerts: In 15 minutes"
            echo "  â€¢ Historical summary: In 6 hours"
          else
            echo "âš ï¸  ATTENTION REQUIRED"
            echo ""
            if [ "${{ needs.monitor-alerts.result }}" != "success" ]; then
              echo "âŒ CRITICAL: Real-time alert system failed!"
              echo "   â†’ Email/SMS/Push notifications may not be sent"
              echo "   â†’ Immediate investigation required"
            fi
            if [ "${{ needs.generate-insights.result }}" != "success" ]; then
              echo "âš ï¸  Warning: Summary generation failed"
              echo "   â†’ Dashboard insights not updated"
              echo "   â†’ Alerts still working independently"
            fi
            echo ""
            echo "Troubleshooting checklist:"
            echo "  1. âœ“ Firebase service account key is valid"
            echo "  2. âœ“ Gmail credentials are correct"
            echo "  3. âœ“ Semaphore API key is correct"
            echo "  4. âœ“ Sensor is sending data regularly"
            echo "  5. âœ“ Network connectivity is stable"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âš ï¸ Report System Failure
        if: needs.monitor-alerts.result == 'failure' || needs.generate-insights.result == 'failure'
        run: |
          echo "ğŸš¨ SYSTEM ALERT: One or more monitoring jobs failed!"
          echo "Please investigate immediately to ensure proper monitoring."
          exit 1
