name: Weather Monitoring System - Complete Automation

on:
  workflow_dispatch: # Manual trigger for testing
    inputs:
      skip_alerts:
        description: "Skip alert checking"
        required: false
        default: "false"
      skip_insights:
        description: "Skip insights generation"
        required: false
        default: "false"

  schedule:
    # Alert monitoring - every 15 minutes (critical for agriculture)
    - cron: "*/15 * * * *"

    # Insights generation - every 6 hours (sufficient for trends)
    # Runs at: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: "0 */6 * * *"

env:
  NODE_VERSION: "18"
  SCRIPTS_PATH: "./scripts"

jobs:
  # ================================================================
  # JOB 1: Alert Monitoring (Runs every 15 minutes)
  # ================================================================
  monitor-alerts:
    name: Monitor Weather Alerts
    runs-on: ubuntu-latest

    # Only run if it's the 15-minute schedule OR manual trigger
    if: |
      github.event.schedule == '*/15 * * * *' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_alerts != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1 # Shallow clone for faster checkout

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸš¨ Check Weather Alerts
        id: check-alerts
        run: node check-all-alerts.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        continue-on-error: true

      - name: âœ… Alert Check Success
        if: steps.check-alerts.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Alert monitoring completed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Check Firestore: alerts_history collection"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Alert Check Failed
        if: steps.check-alerts.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Alert monitoring failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # ================================================================
  # JOB 2: Insights Generation (Runs every 6 hours)
  # ================================================================
  generate-insights:
    name: Generate Weather Insights
    runs-on: ubuntu-latest

    # Only run if it's the 6-hour schedule OR manual trigger
    if: |
      github.event.schedule == '0 */6 * * *' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_insights != 'true')

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Cache Node Modules
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: ${{ env.SCRIPTS_PATH }}/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('scripts/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ”§ Install Dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm install
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ’¡ Generate Smart Insights
        id: generate-insights
        run: node generate-summary.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        continue-on-error: true

      - name: âœ… Insights Generation Success
        if: steps.generate-insights.outcome == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Smart insights generated successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Check Realtime Database: insights/daily_prediction"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âŒ Insights Generation Failed
        if: steps.generate-insights.outcome == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Insights generation failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Check the logs above for error details"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1

  # ================================================================
  # JOB 3: Health Check & Reporting (Runs daily)
  # ================================================================
  system-health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    needs: [monitor-alerts, generate-insights]
    if: always() && github.event.schedule == '0 */6 * * *'

    steps:
      - name: ğŸ“Š Generate Status Report
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š WEATHER MONITORING SYSTEM - STATUS REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Workflow Run: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Job Status:"
          echo "  â€¢ Alert Monitoring: ${{ needs.monitor-alerts.result }}"
          echo "  â€¢ Insights Generation: ${{ needs.generate-insights.result }}"
          echo ""

          if [ "${{ needs.monitor-alerts.result }}" == "success" ] && [ "${{ needs.generate-insights.result }}" == "success" ]; then
            echo "âœ… All systems operational"
            echo ""
            echo "Next scheduled runs:"
            echo "  â€¢ Alerts: In 15 minutes"
            echo "  â€¢ Insights: In 6 hours"
          else
            echo "âš ï¸  Some systems need attention"
            echo ""
            echo "Please check:"
            echo "  1. Firebase service account key is valid"
            echo "  2. Gmail credentials are correct"
            echo "  3. Sensor is sending data"
            echo "  4. Internet connection is stable"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: âš ï¸ Send Failure Notification
        if: needs.monitor-alerts.result == 'failure' || needs.generate-insights.result == 'failure'
        run: |
          echo "ğŸš¨ SYSTEM ALERT: One or more monitoring jobs failed!"
          echo "Please investigate immediately."
          # In production, this would send an email/SMS to admins

  # ================================================================
  # JOB 4: Manual Testing Job (Only on workflow_dispatch)
  # ================================================================
  run-all-tests:
    name: Run All Tests (Manual Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Install Dependencies
        run: npm install
        working-directory: ${{ env.SCRIPTS_PATH }}

      - name: ğŸ§ª Run Alert Check Test
        if: github.event.inputs.skip_alerts != 'true'
        run: |
          echo "Testing alert checking system..."
          node check-all-alerts.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}

      - name: ğŸ§ª Run Insights Generation Test
        if: github.event.inputs.skip_insights != 'true'
        run: |
          echo "Testing insights generation..."
          node generate-summary.js
        working-directory: ${{ env.SCRIPTS_PATH }}
        env:
          FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

      - name: âœ… All Tests Passed
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All manual tests completed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Your system is ready for production!"
          echo ""
          echo "Configured schedules:"
          echo "  â€¢ Alert monitoring: Every 15 minutes"
          echo "  â€¢ Insights generation: Every 6 hours"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
